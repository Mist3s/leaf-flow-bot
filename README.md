# LeafFlow Telegram Bot

Телеграм-бот и HTTP веб-приложение на FastAPI, которое расширяет LeafFlow API и WebApp.

## Стек
- FastAPI — HTTP вебхуки
- aiogram 3 — обработка апдейтов Telegram
- httpx — клиент для LeafFlow API
- Pydantic settings — конфигурация через `.env`

## Быстрый старт
1. Скопируйте `.env.example` в `.env` и заполните токены и URL.
2. Установите зависимости:
   ```bash
   pip install -e .
   ```
3. Запустите приложение (по умолчанию `0.0.0.0:8000`):
   ```bash
   python -m tg_bot.main
   ```
4. Настройте вебхук у Telegram на URL `/telegram/webhook?secret_token=...` (см. `WEBHOOK_SECRET`).

## HTTP эндпоинты
- `POST /telegram/webhook` — вебхук Telegram (проверяет `secret_token`).
- `POST /internal/order-status-changed` — уведомление о статусе заказа (требует Bearer `INTERNAL_LEAFFLOW_TOKEN`).
- `GET /health` — проверка доступности.

## Основные сценарии
- `/start` — приветствие и проверка регистрации в LeafFlow.
- `/orders` — последние заказы и карточка заказа по кнопке «Подробнее».
- `/support` — отправка сообщения в приватный админский чат с кнопкой «Ответить пользователю».
- «Чат по заказу» — связывает конкретный заказ с перепиской, ответы админа копируются пользователю.
- `/help` — краткая справка.

## Скрипты
- `scripts/set_webhook.py` — установка вебхука для бота.

## Разработка
Проект использует структуру пакета `tg_bot` внутри `src/`. При желании добавьте линтеры/тесты в `pyproject.toml`.

## Автодеплой в GitHub Pages
В репозитории настроен workflow `.github/workflows/deploy.yml`, который на каждом push в `main` (или вручную через `workflow_dispatch`) собирает статический бандл и публикует его в GitHub Pages.

1. Включите Pages в **Settings → Pages** и выберите «GitHub Actions» в разделе «Build and deployment».
2. (Опционально) Создайте переменные репозитория `PAGES_BUILD_DIR` и `PAGES_BUILD_COMMAND`:
   - `PAGES_BUILD_DIR` — путь к готовым статическим файлам (по умолчанию `public`).
   - `PAGES_BUILD_COMMAND` — команда сборки фронтенда/WebApp (например, `npm ci && npm run build`). Если переменная пустая, сборка пропускается, а при отсутствии каталога будет загружена плейсхолдер-страница.
3. При необходимости настройте зависимости в самом репозитории (например, добавьте `package.json` с командами сборки или положите готовые файлы в каталог, который укажете в `PAGES_BUILD_DIR`).
4. `GITHUB_TOKEN` используется автоматически, дополнительные секреты для деплоя Pages не нужны.

После успешного выполнения workflow ссылка на сайт появится в окружении `github-pages` в табе **Actions**. При смене путей или команд можно менять только переменные, без изменения кода workflow.
